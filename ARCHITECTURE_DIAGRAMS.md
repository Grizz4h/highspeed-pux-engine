# Architecture & Data Flow Diagrams

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PUX LEAGUE GENERATOR                             â”‚
â”‚                       (LigageneratorV2.py)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Simulate Matchday      â”‚
                    â”‚  - Run 9 matches        â”‚
                    â”‚  - Calculate results    â”‚
                    â”‚  - Update standings     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ save_spieltag_json()    â”‚
                    â”‚ (existing function)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Output: spieltag_XX.json â”‚
                   â”‚  â”œâ”€ Results               â”‚
                   â”‚  â”œâ”€ Standings (Nord/Sued) â”‚
                   â”‚  â”œâ”€ Lineups              â”‚
                   â”‚  â””â”€ Debug info           â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   [NEW] Narrative       â”‚
                    â”‚      Generation         â”‚
                    â”‚  (narrative_engine.py)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ Load:                 â”‚
                     â”‚ - spieltag_XX.json â—€â”€â”€â”˜
                     â”‚ - latest.json â—€â”€â”
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  For Each Match:                                  â”‚
        â”‚  â”œâ”€ form_score(home_last5) â†’ int                 â”‚
        â”‚  â”œâ”€ form_score(away_last5) â†’ int                 â”‚
        â”‚  â”œâ”€ classify_narrative(match, forms) â†’ str        â”‚
        â”‚  â”œâ”€ pick_template(type, seed) â†’ str              â”‚
        â”‚  â”œâ”€ format("{Winner} ... {Loser}") â†’ str         â”‚
        â”‚  â”œâ”€ truncate to 75 chars if needed               â”‚
        â”‚  â””â”€ collect metadata                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Output: narratives.json â”‚
                    â”‚ â”œâ”€ line1 (â‰¤75 chars)    â”‚
                    â”‚ â”œâ”€ type (narrative)     â”‚
                    â”‚ â””â”€ meta (details)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Continue Pipeline:      â”‚
                    â”‚ - save_replay_json()    â”‚
                    â”‚ - save_league_stats()   â”‚
                    â”‚ - etc.                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Classification Decision Tree

```
                    Start: Classify Match
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Shootout? (ğŸ”´ = true) â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ SO_DRAMA         â”‚
                â”‚ (Winner) siegt   â”‚
                â”‚ im Shootout      â”‚
                â”‚ gegen (Loser)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Overtime?        â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ OT_DRAMA         â”‚
                â”‚ (Winner) siegt   â”‚
                â”‚ in der OT        â”‚
                â”‚ gegen (Loser)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Loser scored 0 goals?    â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ SHUTOUT          â”‚
                â”‚ (Winner)         â”‚
                â”‚ shutout          â”‚
                â”‚ (Loser)          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Margin >= 5 goals?       â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ DOMINATION       â”‚
                â”‚ (Winner)         â”‚
                â”‚ dominiert        â”‚
                â”‚ (Loser)          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Margin >= 3 goals?       â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   â”‚ Form diff <= -3?         â”‚
                    â”‚   â”‚ (Underdog beat favorite) â”‚
                    â”‚   â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚      â”‚ Yes
                    â”‚      â””â”€â–¶ UPSET
                    â”‚      â”‚ No
                    â”‚      â””â”€â–¶ STATEMENT_WIN
                    â”‚
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Form diff <= -3?         â”‚
                â”‚ (Underdog beat favorite) â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ UPSET            â”‚
                â”‚ (Winner)         â”‚
                â”‚ Ã¼berrascht       â”‚
                â”‚ (Loser)          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Margin == 1 goal?        â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ GRIND_WIN        â”‚
                â”‚ (Winner) siegt   â”‚
                â”‚ knapp gegen      â”‚
                â”‚ (Loser)          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Total goals >= 7?        â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ TRACK_MEET       â”‚
                â”‚ (Winner) und     â”‚
                â”‚ (Loser) liefern  â”‚
                â”‚ sich ein         â”‚
                â”‚ Tor-Feuerwerk    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Total goals <= 3?        â”‚
                â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Yes
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ LOW_SCORING      â”‚
                â”‚ (Winner) siegt   â”‚
                â”‚ in zÃ¤hem Spiel   â”‚
                â”‚ gegen (Loser)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ No
                â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ FALLBACK         â”‚
                â”‚ (Winner)         â”‚
                â”‚ schlÃ¤gt (Loser)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Transformation Pipeline

```
INPUT SOURCES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

spieltag_XX.json (Spieltag Matches)
â”œâ”€ Match Results:
â”‚  â”œâ”€ home: "Team A"
â”‚  â”œâ”€ away: "Team B"
â”‚  â”œâ”€ g_home: 3
â”‚  â”œâ”€ g_away: 1
â”‚  â”œâ”€ overtime: false
â”‚  â””â”€ shootout: false
â””â”€ Standings:
   â”œâ”€ tabelle_nord: [Team objects]
   â””â”€ tabelle_sued: [Team objects]

latest.json (Team Form Data)
â”œâ”€ teams: [
â”‚  â”œâ”€ {team: "Team A", last5: ["W","W","L","W","W"], ...}
â”‚  â”œâ”€ {team: "Team B", last5: ["L","L","L","L","L"], ...}
â”‚  â””â”€ ...
â”‚  ]
â””â”€ ...

                    â”‚
                    â–¼
TRANSFORMATION FUNCTIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

form_score(["W","W","L","W","W"]) = +3
form_score(["L","L","L","L","L"]) = -5

classify_narrative(
  match={home:A, away:B, g_home:3, g_away:1, ...},
  home_form=+3,
  away_form=-5
) = "STATEMENT_WIN"

pick_template(
  "STATEMENT_WIN",
  "1-5-Team A-Team B-3-1"
) = "...gibt {Loser} eine Lektion."

format_template(
  "...gibt {Loser} eine Lektion.",
  winner="Team A",
  loser="Team B"
) = "Team A gibt Team B eine Lektion."

validate_and_truncate(
  "Team A gibt Team B eine Lektion."  [34 chars]
) = "Team A gibt Team B eine Lektion."  [OK â‰¤75]

                    â”‚
                    â–¼
OUTPUT
â”€â”€â”€â”€â”€â”€

narratives_XX.json
â”œâ”€ "Team A-Team B": {
â”‚  â”œâ”€ line1: "Team A gibt Team B eine Lektion."
â”‚  â”œâ”€ type: "STATEMENT_WIN"
â”‚  â””â”€ meta: {
â”‚     â”œâ”€ margin: 2
â”‚     â”œâ”€ total_goals: 4
â”‚     â”œâ”€ form_diff: 8
â”‚     â”œâ”€ home_form: 3
â”‚     â”œâ”€ away_form: -5
â”‚     â”œâ”€ winner: "Team A"
â”‚     â”œâ”€ loser: "Team B"
â”‚     â”œâ”€ score: "3:1"
â”‚     â”œâ”€ overtime: false
â”‚     â””â”€ shootout: false
â”‚  }
â””â”€ ... (more matches)
```

## Module Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LigageneratorV2.py         â”‚
â”‚  (Main Simulation Loop)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ imports
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  narrative_engine.py        â”‚ [NEW MODULE]
â”‚                             â”‚
â”‚  â”œâ”€ form_score()           â”‚
â”‚  â”œâ”€ classify_narrative()    â”‚
â”‚  â”œâ”€ pick_template()         â”‚
â”‚  â”œâ”€ build_narratives_for_  â”‚
â”‚  â”‚  matchday()              â”‚
â”‚  â”œâ”€ write_narratives_json() â”‚
â”‚  â””â”€ TEMPLATES dict          â”‚
â”‚                             â”‚
â”‚  Dependencies:              â”‚
â”‚  â”œâ”€ json (stdlib)           â”‚
â”‚  â”œâ”€ hashlib (stdlib)        â”‚
â”‚  â”œâ”€ pathlib (stdlib)        â”‚
â”‚  â””â”€ typing (stdlib)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”‚
                    â”‚ imports during tests
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ test_narrative_     â”‚
         â”‚ engine.py [NEW]     â”‚
         â”‚                     â”‚
         â”‚ â”œâ”€ test_form_score()â”‚
         â”‚ â”œâ”€ test_classify_() â”‚
         â”‚ â”œâ”€ test_pick_tmpl() â”‚
         â”‚ â””â”€ test_build_()    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Template Selection Algorithm

```
                    Input Match
                    â”œâ”€ Season: 1
                    â”œâ”€ Spieltag: 5
                    â”œâ”€ Home: "Team A"
                    â”œâ”€ Away: "Team B"
                    â”œâ”€ Goals: 3:1
                    â””â”€ Type: "STATEMENT_WIN"
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Build seed string:    â”‚
                â”‚ "1-5-Team A-Team B-   â”‚
                â”‚  3-1"                 â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Calculate MD5 hash:         â”‚
                â”‚ hashlib.md5(seed_str)       â”‚
                â”‚ â†’ 0x2f4e8c7a...             â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Convert to integer:          â”‚
                â”‚ int(0x2f4e8c7a..., 16)      â”‚
                â”‚ â†’ 795234875210              â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Get modulo pool size:        â”‚
                â”‚ 795234875210 % 5 (templates) â”‚
                â”‚ â†’ 3                          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Select template:             â”‚
                â”‚ TEMPLATES["STATEMENT_WIN"][3]â”‚
                â”‚ â†’ "...gibt {Loser} eine..." â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Substitute placeholders:     â”‚
                â”‚ {Winner} â†’ "Team A"          â”‚
                â”‚ {Loser} â†’ "Team B"           â”‚
                â”‚ â†’ "Team A gibt Team B eine..â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Final output:                â”‚
                â”‚ "Team A gibt Team B eine     â”‚
                â”‚  Lektion." [â‰¤75 chars]       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

```
         narrative_engine.py execution starts
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Try to generate       â”‚
            â”‚ narratives            â”‚
            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚
        â–¼ (success)      â–¼ (exception)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Write  â”‚      â”‚ Catch error  â”‚
    â”‚ output â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜             â”‚
         â”‚            â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚            â”‚ Log error:   â”‚
         â”‚            â”‚ exception    â”‚
         â”‚            â”‚ message      â”‚
         â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
              â”‚        â”‚
              â–¼        â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Continue with    â”‚
         â”‚ next step in     â”‚
         â”‚ pipeline:        â”‚
         â”‚ save_replay_json â”‚
         â”‚ (no crash!)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Timeline

```
Time (ms)    Action                        Duration
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
0 ms    â”‚ Load spieltag_XX.json           
1 ms    â”‚â”œâ”€ Parsing JSON                  < 1 ms
2 ms    â”‚â”œâ”€ Deserialize to dict           < 1 ms
        â”‚
        â”‚ Load latest.json
3 ms    â”‚â”œâ”€ Parsing JSON                  < 1 ms
4 ms    â”‚â”œâ”€ Deserialize to dict           < 1 ms
        â”‚
        â”‚ [For each of 9 matches]:
5 ms    â”‚â”œâ”€ Match 1:
6 ms    â”‚ â”‚â”œâ”€ form_score (home) â†’ +2     < 1 ms
7 ms    â”‚ â”‚â”œâ”€ form_score (away) â†’ -1     < 1 ms
8 ms    â”‚ â”‚â”œâ”€ classify_narrative()        < 1 ms
9 ms    â”‚ â”‚â”œâ”€ pick_template()             < 1 ms
10 ms   â”‚ â”‚â”œâ”€ format string               < 1 ms
11 ms   â”‚ â”‚â””â”€ validate/truncate           < 1 ms
        â”‚ â”‚
12 ms   â”‚ â”œâ”€ Match 2...                   < 1 ms
...
47 ms   â”‚ â”œâ”€ Match 9...                   < 1 ms
        â”‚
        â”‚ Build output dict
48 ms   â”‚â”œâ”€ Aggregate results             < 1 ms
        â”‚
        â”‚ Write narratives_XX.json
49 ms   â”‚â”œâ”€ Serialize to JSON             < 1 ms
50 ms   â”‚â”œâ”€ Write to disk                 < 1 ms
51 ms   â”‚â”œâ”€ Verify round-trip             < 1 ms
        â”‚
52 ms   â””â”€ COMPLETE
        
Total:  52 ms (target: < 100 ms) âœ…
```

## Integration Timeline (in step_one_spieltag)

```
Time    Function/Step                   Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0     Simulate matchday              [Running]
T+100   Calculate all results           [Done]
T+150   save_spieltag_json()           [Done]
        â†’ spieltag_XX.json written
        
T+160   [NEW] Narrative generation    [Running]
        â”œâ”€ Load spieltag_XX.json
        â”œâ”€ Load latest.json
        â”œâ”€ build_narratives_for_matchday()
        â”œâ”€ write_narratives_json()
        â†’ narratives_XX.json written
T+210   [NEW] Complete                 [Done]
        
T+220   save_replay_json()             [Running]
T+280   save_league_stats_snapshot()   [Running]
T+350   [Continue with pipeline]       [OK]
        
Total overhead: 50 ms (negligible)
```

This completes the architecture documentation.
